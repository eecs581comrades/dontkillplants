<!-- 
Name of code artifact: View Saved Simulations Page
Description: Page with simulations generated by user given after logging in
Name(s): Chase Curtis
Date Created: 10-27-24
Dates Revised: 

Preconditions: User must be logged in to view saved simulations.

Acceptable/unacceptable input values/types, and meanings: 
- Acceptable: Valid user ID stored in localStorage. 
- Unacceptable: Missing or invalid user ID.

Postconditions: Displays simulations for the logged-in user or relevant messages if none exist.

Return values/types, and meanings: 
- Returns an array of simulation objects or an error message if retrieval fails.

Error and exception condition values/types that can occur, and meanings: 
- Network errors during fetch, user not logged in, or empty simulation list.

Side effects: 
- Updates the DOM with simulation buttons or error messages.

Invariants: 
- The page structure remains consistent regardless of user data.

Known faults: 
- None identified; potential for improvement in error handling and user experience.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Don't Kill Plants</title> <!-- Title of the page displayed in the browser tab -->
    <link rel="icon" href="css/img/the_guy.png" type="image/png"> <!-- Favicon for the webpage -->
    <script type="text/javascript" src="js/themeToggle.js"></script> <!--Connects Javascript for theme switching-->
    <link id="theme" rel="stylesheet" type="text/css" href="css/general.css" /> <!--Connects default CSS for theme switching-->
    <style>
        .calendar-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 50vh;
        }
        .calendar {
            width: 300px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            justify-content: center;
            align-items: center;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #007BFF;
            color: white;
        }

        .header button {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .days, .dates {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
        }

        .day {
            font-weight: bold;
            padding: 10px 0;
            background: #f1f1f1;
        }

        .date {
            padding: 10px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .date:hover {
            background: #ddd;
        }

        .date.today {
            background: #007BFF;
            color: white;
            border-radius: 50%;
        }

        .event {
            font-size: 10px;
            color: #555;
            background: #e3f2fd;
            border-radius: 4px;
            padding: 2px 4px;
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            cursor: pointer;
        }

        .event-input {
            display: none;
            flex-direction: column;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .event-input input {
            margin-bottom: 10px;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .event-input button {
            padding: 8px;
            border: none;
            color: white;
            background: #007BFF;
            cursor: pointer;
            border-radius: 4px;
        }

        .event-input button.cancel {
            background: #555;
        }
    </style>
</head>
<body>
    <button class="themeButton" onclick="toggleTheme()"></button> <!--Calls Javascript function to change css theme when button is pressed-->
    <div class="container"> <!-- Main container for the page layout -->
        <h1 style="text-align: center;">View Simulations</h1> <!-- Header for the page -->
        <table>
            <tr>
                <td>
                    <div class="box" style="height: 500px; width: 500px;"> <!-- Box containing the simulation title and buttons -->
                        <div id="simulations"></div> <!-- Div to hold the simulation buttons -->
                    </div>
                </td>
                <td>
                    <div class="calendar-wrapper">
                        <div class="calendar">
                            <div class="header">
                                <button id="prev">❮</button>
                                <span id="monthYear"></span>
                                <button id="next">❯</button>
                            </div>
                            <div class="days">
                                <div class="day">Sun</div>
                                <div class="day">Mon</div>
                                <div class="day">Tue</div>
                                <div class="day">Wed</div>
                                <div class="day">Thu</div>
                                <div class="day">Fri</div>
                                <div class="day">Sat</div>
                            </div>
                            <div id="dates" class="dates"></div>
                        </div>
                
                        <div id="eventInput" class="event-input">
                            <input id="eventText" type="text" placeholder="Enter event">
                            <button id="addEvent">Add Event</button>
                            <button id="cancelEvent" class="cancel">Cancel</button>
                        </div>
                    </div>
                </td>
            </tr>
        </table>
        <div>
            <button onclick="location.href='simulation.html'">New Simulation</button><!-- Button to navigate to the new simulation page -->
            <button onclick="window.location.href='home.html'">Home</button> <!-- Button to navigate to the home page -->
            <button onclick="window.location.href='changePass.html'">Change Password</button>
            <button id="filter-button">Change Mandrake</button>
            <button id="cat-button">CAT Mode</button>
        </div>
    </div>
    <input id="filterable" class="homeButton" type="image" src="css/img/the_guy.png" onclick="window.location.href='home.html'"Home/>
    <image id="cat" src="css/img/the_cat.png">
    <script src="js/changeTheGuy.js"></script> <!--Connects Javascript for mandrake filters-->
    <script src="js/catMode.js"></script>
    <script>

        // Retrieve user ID from localStorage
        const userId = localStorage.getItem('userId'); // Fetch the user ID from local storage

        if(userId != 'null'){
            fetch(`http://localhost:5100/account/pull_preference/darkMode/${userId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch user preferences");
                    }
                    return response.json();
                })
                .then(data => {
                    const user = data[0];
                    if (user.darkMode === 1) {
                        localStorage.setItem('darkMode', 'true');
                    } else {
                        localStorage.setItem('darkMode', 'false');
                    }
                    updateDarkModeState();
                })
        } else {
            updateDarkModeState();
        }

        function updateDarkModeState(){
            const darkMode = localStorage.getItem('darkMode'); // Fetch the dark mode preference from local storage
            console.log('Dark mode:', darkMode); // Log the dark mode preference

            if (darkMode === 'true') {
                theme.setAttribute('href', 'css/dark.css');
            } else {
                theme.setAttribute('href', 'css/general.css');
            }
        }

        if (userId) { // Check if user ID exists
            // Fetch simulations for the user
            fetch(`http://localhost:5100/simulations/${userId}`) // Send a GET request to the server for simulations
                .then(response => {
                    if (!response.ok) { // Check if the response is not okay
                        throw new Error("Failed to fetch simulations"); // Throw an error if the response is bad
                    }
                    return response.json(); // Parse the response JSON
                })
                .then(data => {
                    const simulationsDiv = document.getElementById('simulations'); // Get the simulations div

                    // Clear any existing content
                    simulationsDiv.innerHTML = ''; // Clear the div before displaying new simulations

                    // Check if there are simulations
                    if (data.length > 0) { // If data contains simulations
                        data.forEach(simulation => {
                            // Fetch plant name by plant ID
                            fetch(`http://localhost:5100/search/id/${encodeURIComponent(simulation.plant_id)}`) 
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error("Failed to fetch plant details");
                                    }
                                    return response.json();
                                })
                                .then(data2 => {
                                    const plant = data2[0];
                                    const simulationDiv = document.createElement('div'); // Create a container for the simulation

                                    // Create button for viewing the simulation
                                    const viewButton = document.createElement('button');
                                    viewButton.innerText = `Plant Name: ${plant.plant_common_name}`;
                                    viewButton.onclick = () => {
                                        localStorage.setItem('plantId', simulation.plant_id);
                                        localStorage.setItem('simulationId', simulation.simulation_id);
                                        window.location.href = `simResultsSaved.html`;
                                    };
                                    viewButton.style.margin = '5px';
                                    viewButton.style.position = 'relative'; // Make view button a positioning context

                                    // Delete button (gray circle with "X")
                                    const deleteButton = document.createElement('button');
                                    deleteButton.innerText = '×'; // The "X" character
                                    deleteButton.style.position = 'absolute';
                                    deleteButton.style.top = '-10px'; // Move the button slightly higher
                                    deleteButton.style.right = '-10px'; // Move the button slightly to the right
                                    deleteButton.style.width = '30px'; // Circle size (adjust this as needed)
                                    deleteButton.style.height = '30px'; // Circle size (same as width for circle)
                                    deleteButton.style.borderRadius = '50%'; // Make it round
                                    deleteButton.style.backgroundColor = '#888'; // Gray background
                                    deleteButton.style.color = 'white'; // White "X"
                                    deleteButton.style.border = 'none';
                                    deleteButton.style.fontSize = '20px'; // Size of the "X"
                                    deleteButton.style.textAlign = 'center';
                                    deleteButton.style.lineHeight = '30px'; // Center the "X" vertically
                                    deleteButton.style.cursor = 'pointer';
                                    deleteButton.style.padding = '0'; // Remove any extra padding around the "X"

                                    // hover effect 
                                    deleteButton.onmouseover = () => {
                                        deleteButton.style.backgroundColor = '#555'; // Darken when hovered
                                    };

                                    deleteButton.onmouseout = () => {
                                        deleteButton.style.backgroundColor = '#888'; // Return to original gray
                                    };

                                    // Button action for delete
                                    deleteButton.onclick = () => {
                                        if (confirm('Are you sure you want to delete this simulation?')) {
                                            fetch(`http://localhost:5100/simulations/delete/${simulation.simulation_id}`, {
                                                method: 'DELETE',
                                            })
                                                .then(response => {
                                                    if (!response.ok) {
                                                        throw new Error('Failed to delete simulation');
                                                    }
                                                    alert('Simulation deleted successfully.');
                                                    location.reload(); // Reload the page to reflect changes
                                                })
                                                .catch(error => {
                                                    console.error('Error deleting simulation:', error);
                                                });
                                        }
                                    };

                                    // Make a container for the view button and delete button
                                    const buttonContainer = document.createElement('div');
                                    buttonContainer.style.position = 'relative';
                                    buttonContainer.style.display = 'inline-block'; // Ensure proper wrapping of the buttons
                                    buttonContainer.appendChild(viewButton);
                                    buttonContainer.appendChild(deleteButton);

                                    // Add the container to the simulations div
                                    simulationsDiv.appendChild(buttonContainer);

                                })
                                .catch(error => {
                                    console.error('Error fetching plant details:', error);
                                });
                        });

                    } else {
                        simulationsDiv.innerHTML = '<p>No simulations found.</p>'; // Message if no simulations are available
                    }
                })
                .catch(error => {
                    console.error('Error fetching simulations:', error); // Log any errors to the console
                    document.getElementById('simulations').innerHTML = '<p>Error retrieving simulations. Please try again.</p>'; // Show error message on the page
                });
        } else {
            document.getElementById('simulations').innerHTML = '<p>User not logged in. Please log in to see simulations.</p>'; // Message if user is not logged in
        }
    </script>
    <script>
        const monthYear = document.getElementById("monthYear");
        const dates = document.getElementById("dates");
        const prev = document.getElementById("prev");
        const next = document.getElementById("next");
        const eventInput = document.getElementById("eventInput");
        const eventText = document.getElementById("eventText");
        const addEvent = document.getElementById("addEvent");
        const cancelEvent = document.getElementById("cancelEvent");
    
        let currentDate = new Date();
        let events = {}; // Object to store events
        let selectedDate = null;
    
        // Load saved events from localStorage
        function loadEvents() {
            const userId = localStorage.getItem("userId").toString();
            const savedEvents = localStorage.getItem(userId + "_calendarEvents");
            if (savedEvents) {
                events = JSON.parse(savedEvents);
            }
            if(userId != 'null'){
                fetch(`http://localhost:5100/account/calendar/${userId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Failed to fetch user calendar events");
                        }
                        return response.json();
                    })
                    .then(data => {
                        const user = data[0];
                        events = user.calendar_info ? JSON.parse(user.calendar_info) : events;
                        localStorage.setItem(userId + "_calendarEvents", JSON.stringify(events));
                    });
                }
            }
    
        // Save events to localStorage
        function saveEvents() {
            const userId = localStorage.getItem("userId").toString();
            localStorage.setItem(userId + "_calendarEvents", JSON.stringify(events));
        }
    
        function renderCalendar(date) {
            dates.innerHTML = "";
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
    
            const options = { month: "long", year: "numeric" };
            monthYear.textContent = new Intl.DateTimeFormat("en-US", options).format(date);
    
            for (let i = 0; i < firstDay; i++) {
                const blank = document.createElement("div");
                blank.className = "date";
                dates.appendChild(blank);
            }
    
            for (let day = 1; day <= lastDate; day++) {
                const dateDiv = document.createElement("div");
                dateDiv.className = "date";
                if (
                    day === new Date().getDate() &&
                    month === new Date().getMonth() &&
                    year === new Date().getFullYear()
                ) {
                    dateDiv.classList.add("today");
                }
                dateDiv.textContent = day;
    
                const eventKey = `${year}-${month}-${day}`;
                if (events[eventKey]) {
                    const eventDiv = document.createElement("div");
                    eventDiv.className = "event";
                    eventDiv.textContent = events[eventKey];
                    dateDiv.appendChild(eventDiv);
                }
    
                dateDiv.addEventListener("click", () => {
                    selectedDate = eventKey;
                    eventInput.style.display = "flex";
                });
    
                dates.appendChild(dateDiv);
            }
        }
    
        prev.addEventListener("click", () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
        });
    
        next.addEventListener("click", () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
        });
    
        addEvent.addEventListener("click", () => {
            if (selectedDate && eventText.value.trim()) {
                events[selectedDate] = eventText.value.trim();
                saveEvents(); // Save the updated events to localStorage
                eventText.value = "";
                eventInput.style.display = "none";
                renderCalendar(currentDate);
            }
        });
    
        cancelEvent.addEventListener("click", () => {
            eventText.value = "";
            eventInput.style.display = "none";
        });
    
        // Initialize the calendar
        loadEvents(); // Load saved events when the page loads
        renderCalendar(currentDate);
    </script>
    
</body>
</html>
