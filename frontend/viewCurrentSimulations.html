<!-- 
Name of code artifact: View Saved Simulations Page
Description: Page with simulations generated by user given after logging in
Name(s): Chase Curtis
Date Created: 10-27-24
Dates Revised: 

Preconditions: User must be logged in to view saved simulations.

Acceptable/unacceptable input values/types, and meanings: 
- Acceptable: Valid user ID stored in localStorage. 
- Unacceptable: Missing or invalid user ID.

Postconditions: Displays simulations for the logged-in user or relevant messages if none exist.

Return values/types, and meanings: 
- Returns an array of simulation objects or an error message if retrieval fails.

Error and exception condition values/types that can occur, and meanings: 
- Network errors during fetch, user not logged in, or empty simulation list.

Side effects: 
- Updates the DOM with simulation buttons or error messages.

Invariants: 
- The page structure remains consistent regardless of user data.

Known faults: 
- None identified; potential for improvement in error handling and user experience.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Don't Kill Plants</title> <!-- Title of the page displayed in the browser tab -->
    <link rel="icon" href="css/img/the_guy.png" type="image/png"> <!-- Favicon for the webpage -->
    <script type="text/javascript" src="js/themeToggle.js"></script> <!--Connects Javascript for theme switching-->
    <link id="theme" rel="stylesheet" type="text/css" href="css/general.css" /> <!--Connects default CSS for theme switching-->
</head>
<body>
    <button class="themeButton" onclick="toggleTheme()"></button> <!--Calls Javascript function to change css theme when button is pressed-->
    <div class="container"> <!-- Main container for the page layout -->
        <div class="box" style="height: 500px; width: 500px;"> <!-- Box containing the simulation title and buttons -->
            <h1 style="text-align: center;">View Simulations</h1> <!-- Header for the page -->
            <div id="simulations"></div> <!-- Div to hold the simulation buttons -->
        </div>
        <div>
            <button onclick="location.href='simulation.html'">New Simulation</button><!-- Button to navigate to the new simulation page -->
            <button onclick="window.location.href='home.html'">Home</button> <!-- Button to navigate to the home page -->
            <button onclick="window.location.href='changePass.html'">Change Password</button>
            <button id="filter-button">Change Mandrake</button>
            <button id="cat-button">CAT Mode</button>
        </div>
    </div>
    <input id="filterable" class="homeButton" type="image" src="css/img/the_guy.png" onclick="window.location.href='home.html'"Home/>
    <script src="js/changeTheGuy.js"></script><!--Loads user's mandrake filter-->
    <script>

        const darkMode = localStorage.getItem('darkMode');

        if (darkMode === 'enabled') {
            theme.setAttribute('href', 'css/dark.css');
        } else {
            theme.setAttribute('href', 'css/general.css');
        }

        // Retrieve user ID from localStorage
        const userId = localStorage.getItem('userId'); // Fetch the user ID from local storage

        if (userId) { // Check if user ID exists
            // Fetch simulations for the user
            fetch(`http://localhost:5100/simulations/${userId}`) // Send a GET request to the server for simulations
                .then(response => {
                    if (!response.ok) { // Check if the response is not okay
                        throw new Error("Failed to fetch simulations"); // Throw an error if the response is bad
                    }
                    return response.json(); // Parse the response JSON
                })
                .then(data => {
                    const simulationsDiv = document.getElementById('simulations'); // Get the simulations div

                    // Clear any existing content
                    simulationsDiv.innerHTML = ''; // Clear the div before displaying new simulations

                    // Check if there are simulations
                    if (data.length > 0) { // If data contains simulations
                        data.forEach(simulation => {
                            // Fetch plant name by plant ID
                            fetch(`http://localhost:5100/search/id/${encodeURIComponent(simulation.plant_id)}`) 
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error("Failed to fetch plant details");
                                    }
                                    return response.json();
                                })
                                .then(data2 => {
                                    const plant = data2[0];
                                    const simulationDiv = document.createElement('div'); // Create a container for the simulation

                                    // Create button for viewing the simulation
                                    const viewButton = document.createElement('button');
                                    viewButton.innerText = `Plant Name: ${plant.plant_common_name}`;
                                    viewButton.onclick = () => {
                                        localStorage.setItem('plantId', simulation.plant_id);
                                        localStorage.setItem('simulationId', simulation.simulation_id);
                                        window.location.href = `simResultsSaved.html`;
                                    };
                                    viewButton.style.margin = '5px';
                                    viewButton.style.position = 'relative'; // Make view button a positioning context

                                    // Delete button (gray circle with "X")
                                    const deleteButton = document.createElement('button');
                                    deleteButton.innerText = 'Ã—'; // The "X" character
                                    deleteButton.style.position = 'absolute';
                                    deleteButton.style.top = '-10px'; // Move the button slightly higher
                                    deleteButton.style.right = '-10px'; // Move the button slightly to the right
                                    deleteButton.style.width = '30px'; // Circle size (adjust this as needed)
                                    deleteButton.style.height = '30px'; // Circle size (same as width for circle)
                                    deleteButton.style.borderRadius = '50%'; // Make it round
                                    deleteButton.style.backgroundColor = '#888'; // Gray background
                                    deleteButton.style.color = 'white'; // White "X"
                                    deleteButton.style.border = 'none';
                                    deleteButton.style.fontSize = '20px'; // Size of the "X"
                                    deleteButton.style.textAlign = 'center';
                                    deleteButton.style.lineHeight = '30px'; // Center the "X" vertically
                                    deleteButton.style.cursor = 'pointer';
                                    deleteButton.style.padding = '0'; // Remove any extra padding around the "X"

                                    // hover effect 
                                    deleteButton.onmouseover = () => {
                                        deleteButton.style.backgroundColor = '#555'; // Darken when hovered
                                    };

                                    deleteButton.onmouseout = () => {
                                        deleteButton.style.backgroundColor = '#888'; // Return to original gray
                                    };

                                    // Button action for delete
                                    deleteButton.onclick = () => {
                                        if (confirm('Are you sure you want to delete this simulation?')) {
                                            fetch(`http://localhost:5100/simulations/delete/${simulation.simulation_id}`, {
                                                method: 'DELETE',
                                            })
                                                .then(response => {
                                                    if (!response.ok) {
                                                        throw new Error('Failed to delete simulation');
                                                    }
                                                    alert('Simulation deleted successfully.');
                                                    location.reload(); // Reload the page to reflect changes
                                                })
                                                .catch(error => {
                                                    console.error('Error deleting simulation:', error);
                                                });
                                        }
                                    };

                                    // Make a container for the view button and delete button
                                    const buttonContainer = document.createElement('div');
                                    buttonContainer.style.position = 'relative';
                                    buttonContainer.style.display = 'inline-block'; // Ensure proper wrapping of the buttons
                                    buttonContainer.appendChild(viewButton);
                                    buttonContainer.appendChild(deleteButton);

                                    // Add the container to the simulations div
                                    simulationsDiv.appendChild(buttonContainer);

                                })
                                .catch(error => {
                                    console.error('Error fetching plant details:', error);
                                });
                        });

                    } else {
                        simulationsDiv.innerHTML = '<p>No simulations found.</p>'; // Message if no simulations are available
                    }
                })
                .catch(error => {
                    console.error('Error fetching simulations:', error); // Log any errors to the console
                    document.getElementById('simulations').innerHTML = '<p>Error retrieving simulations. Please try again.</p>'; // Show error message on the page
                });
        } else {
            document.getElementById('simulations').innerHTML = '<p>User not logged in. Please log in to see simulations.</p>'; // Message if user is not logged in
        }
    </script>
</body>
</html>
